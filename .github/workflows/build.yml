name: Build ImmortalWrt SL-3000 Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          sudo rm -rf /opt/ghc /opt/hostedtoolcache /usr/local/lib/android
          sudo docker image prune -a -f
          df -h

      - name: ğŸ“¥ æ‹‰å–æºç 
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3 python3-pip python3-venv rsync unzip zlib1g-dev file wget

      - name: ğŸ”§ æ›´æ–° feeds å¹¶å®‰è£…
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ğŸ“¦ æ·»åŠ  SL-3000 è®¾å¤‡æ”¯æŒ
        run: |
          mkdir -p target/linux/mediatek/files-5.15/arch/arm64/boot/dts/mediatek
          cp -v devices/sl-3000-emmc/sl-3000-emmc.dts target/linux/mediatek/files-5.15/arch/arm64/boot/dts/mediatek/
          echo -e '\ndefine Device/sl-3000-emmc\n  DEVICE_VENDOR := Silicon\n  DEVICE_MODEL := SL-3000\n  DEVICE_DTS := sl-3000-emmc\n  DEVICE_PACKAGES := kmod-usb3 kmod-mmc kmod-leds-gpio kmod-gpio-button\nendef\nTARGET_DEVICES += sl-3000-emmc' >> target/linux/mediatek/image/mt7981.mk

      - name: ğŸ“„ åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          cp devices/sl-3000-emmc/.config .config

      - name: âš™ï¸ åˆå§‹åŒ–é…ç½®
        run: make defconfig

      - name: ğŸ“¦ ä¸‹è½½ä¾èµ–åŒ…
        run: make download -j$(nproc) || make download -j1 V=s

      - name: ğŸš€ ç¼–è¯‘å›ºä»¶
        run: make -j$(nproc) || make -j1 V=s

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: sl-3000-emmc-firmware
          path: bin/targets/
