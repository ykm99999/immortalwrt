name: Build sl-3000-emmc firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¹ æ¸…ç†ç©ºé—´ï¼ˆç§»é™¤é¢„è£…è½¯ä»¶ï¼‰
        run: |
          sudo rm -rf /opt/ghc /opt/hostedtoolcache /usr/local/lib/android
          sudo docker image prune -a -f
          df -h

      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set up build environment
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3 python3-pip python3-venv rsync unzip zlib1g-dev file wget

      - name: Clone and install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add custom device support
        run: |
          mkdir -p target/linux/mediatek/files-5.15/arch/arm64/boot/dts/mediatek
          cp -v devices/sl-3000-emmc/sl-3000-emmc.dts target/linux/mediatek/files-5.15/arch/arm64/boot/dts/mediatek/
          echo 'define Device/sl-3000-emmc\n  DEVICE_VENDOR := Silicon\n  DEVICE_MODEL := SL-3000\n  DEVICE_DTS := sl-3000-emmc\n  DEVICE_PACKAGES := kmod-usb3 kmod-mmc kmod-leds-gpio kmod-gpio-button\nendef\nTARGET_DEVICES += sl-3000-emmc' >> target/linux/mediatek/image/mt7981.mk

      - name: Load custom config
        run: |
          cp devices/sl-3000-emmc/.config .config

      - name: Clean build cache
        run: |
          make distclean || true
          rm -rf tmp build_dir staging_dir dl

      - name: Start build
        run: |
          make defconfig
          make download -j$(nproc) || make download -j1 V=s
          make -j$(nproc) || make -j1 V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: sl-3000-emmc-firmware
          path: bin/targets/
