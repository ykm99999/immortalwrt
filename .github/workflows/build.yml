name: Build ImmortalWrt SL-3000 Firmware

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  DEVICE_NAME: sl-3000-emmc
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  RELEASE_TAG: sl3000-${{ github.run_id }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clean disk space
        run: |
          echo "Cleaning disk space..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker image prune -a -f
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3 python3-pip python3-venv rsync unzip zlib1g-dev file wget

      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            openwrt/dl
            openwrt/build_dir
          key: ${{ runner.os }}-immortalwrt-${{ hashFiles('devices/${{ env.DEVICE_NAME }}/.config') }}
          restore-keys: |
            ${{ runner.os }}-immortalwrt-

      - name: Clone ImmortalWrt
        run: |
          git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt

      - name: Inject SL-3000 device
        run: |
          cd openwrt
          mkdir -p target/linux/mediatek/files-5.15/arch/arm64/boot/dts/mediatek
          cp -v ../devices/${{ env.DEVICE_NAME }}/${{ env.DEVICE_NAME }}.dts target/linux/mediatek/files-5.15/arch/arm64/boot/dts/mediatek/
          printf "\ndefine Device/${{ env.DEVICE_NAME }}\n  DEVICE_VENDOR := Silicon\n  DEVICE_MODEL := SL-3000\n  DEVICE_DTS := ${{ env.DEVICE_NAME }}\n  DEVICE_PACKAGES := kmod-usb3 kmod-mmc kmod-leds-gpio kmod-gpio-button\nendef\nTARGET_DEVICES += ${{ env.DEVICE_NAME }}\n" >> target/linux/mediatek/image/mt7981.mk

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load config
        run: |
          cp devices/${{ env.DEVICE_NAME }}/.config openwrt/.config

      - name: Configure build
        run: |
          cd openwrt
          echo "CONFIG_CCACHE=y" >> .config
          make defconfig

      - name: Build firmware
        run: |
          cd openwrt
          make download -j"$(nproc)" || make download -j1 V=s
          make -j"$(nproc)" || make -j1 V=s

      - name: Package firmware into zip
        run: |
          cd openwrt/bin/targets
          DEVICE_DIR=$(find . -type d -name "${DEVICE_NAME}" | head -n 1)
          cd $DEVICE_DIR
          zip -r ../../../../${DEVICE_NAME}-firmware.zip *factory*.bin *sysupgrade*.bin *.itb sha256sums

      - name: Generate release notes
        run: |
          cd openwrt/bin/targets
          DEVICE_DIR=$(find . -type d -name "${DEVICE_NAME}" | head -n 1)
          cd $DEVICE_DIR
          echo "### 固件文件列表" > ../../../../release_notes.md
          echo "" >> ../../../../release_notes.md
          for f in *factory*.bin *sysupgrade*.bin *.itb; do
            if [ -f "$f" ]; then
              SUM=$(sha256sum "$f" | awk '{print $1}')
              echo "- $f (sha256: $SUM)" >> ../../../../release_notes.md
            fi
          done
          echo "" >> ../../../../release_notes.md
          echo "编译时间: $(date '+%Y-%m-%d %H:%M:%S')" >> ../../../../release_notes.md

      - name: Upload firmware zip
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE_NAME }}-firmware
          path: ${{ env.DEVICE_NAME }}-firmware.zip

      - name: Create release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: SL-3000 Build ${{ env.RELEASE_TAG }}
          body_path: release_notes.md
          files: ${{ env.DEVICE_NAME }}-firmware.zip

      - name: Delete old releases
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 3   # 保留最近 3 个 Release
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
